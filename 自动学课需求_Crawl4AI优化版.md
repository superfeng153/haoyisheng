# 自动学课需求 (探索与模拟版)

## 引言

本文档旨在为"好医生"在线继续教育平台的自动化学课脚本制定一套全新的、以探索为先导的开发方案。此方案的核心思想是：放弃对页面交互的完全模拟，转而深入分析其背后的网络通信机制。我们首先利用AI辅助的浏览器工具（Playwright MCP）进行交互式探索，精确找到学习进度的上报逻辑，然后基于分析结果，选择最高效的技术（可能是直接模拟API请求）来完成最终的自动化脚本。

## 一、第一阶段：探索与解密

此阶段的目标是完全弄清楚"看课"这一行为在技术层面的本质。

### 1.1 自动登录与会话建立

*   **任务:** 开发一个稳定、独立的自动登录模块。
*   **实现:**
    1.  使用 `Playwright` 或 `Requests` 库处理登录请求。
    2.  集成 `dddocr` 或类似库，用于自动识别图形验证码。
    3.  成功登录后，必须保存 `Cookies` 或 `Local Storage` 到本地文件（如 `cookies.json`），为后续所有操作提供有效的用户会话。这是后续所有步骤的基础。

### 1.2 AI辅助的交互式导航

*   **目标:** 找到从"登录后首页"到"课程视频播放页"的准确路径。
*   **工具:** **AI + Playwright MCP (Multi-Modal Controller)**
*   **流程:**
    1.  编写一个加载步骤1.1中保存的 `cookies.json` 的 Playwright 脚本，直接进入登录后的状态。
    2.  **启动AI交互模式**，通过自然语言指令，一步步操作浏览器。例如：
        *   `"点击'我的课程'菜单"`
        *   `"在课程列表中找到包含'儿科'的课程，然后点击它"`
        *   `"点击'开始学习'或播放按钮"`
    3.  **记录关键步骤:** 在这个过程中，最重要的是记录下每一步操作的URL跳转、关键元素的ID或CSS选择器。这个过程是为了理解网站的导航结构，而不是为了自动化。

### 1.3 学习进度上报的网络请求分析

*   **目标:** 捕获并分析在视频播放页面上，用于向服务器汇报"已学习XX秒"的核心网络请求。
*   **方法:**
    1.  在步骤1.2中到达的视频播放页面，打开浏览器的**开发者工具 (F12)**，并切换到**网络 (Network)**标签页。
    2.  开始播放视频，并密切观察网络请求列表。
    3.  **筛选关键请求:** 寻找那些周期性发送的请求（例如，每30秒或60秒一次），其URL可能包含 `reportProgress`, `updateStudyTime`, `heartbeat` 等关键词。
    4.  **深度分析:** 对找到的关键请求进行全面分析，并记录以下信息：
        *   **Request URL:** 请求的完整地址。
        *   **Request Method:** `GET`, `POST` 等。
        *   **Request Headers:** 特别是 `Cookie`, `Authorization`, `x-requested-with` 等可能包含身份验证信息的头。
        *   **Request Payload/Body:** 如果是POST请求，记录下提交的所有参数及其值。

## 二、第二阶段：实现与自动化

在完全掌握了进度上报请求的细节后，我们开始选择最合适的技术方案。

### 2.1 请求参数来源逆向分析

*   **任务:** 弄清楚在步骤1.3中记录的每一个请求参数，它们究竟从何而来。
*   **分析要点:**
    *   **静态参数？** 这个参数的值是不是固定的？
    *   **来自页面？** 这个参数是否可以在进入视频页面的HTML源码或某个JavaScript变量（如 `window.courseId`）中找到？
    *   **来自先前请求？** 这个参数是否是上一个API请求返回结果的一部分？
    *   **动态计算？** 这个参数是否由页面的JavaScript经过加密、签名或其他复杂运算后生成的？

### 2.2 技术方案决策

根据2.1的分析结果，选择最精简、最高效的实现路径：

#### 方案 A：纯API请求模拟 (首选方案)

*   **适用场景:** 如果所有必需的参数都能通过前述分析轻松获取或重现（即没有复杂的客户端JS加密）。
*   **技术栈:** `Python` + `requests` / `httpx` 库。
*   **优点:**
    *   **极致性能:** 无需启动笨重的浏览器，资源消耗极低。
    *   **运行稳定:** 不受前端页面UI变化的影响。
    *   **易于部署:** 依赖少，可轻松在任何服务器上运行。
*   **实现:** 编写Python脚本，直接构造并发送进度上报的HTTP请求，实现"静默"挂课。

#### 方案 B：浏览器自动化辅助 (备用方案)

*   **适用场景:** 如果关键参数（如 `session_token`, `play_id`）是由页面上难以逆向的复杂JavaScript动态生成的。
*   **技术栈:** `Python` + `Crawl4AI` / `Playwright`。
*   **思路:** 让浏览器成为我们获取动态参数的"工具"。
*   **实现:**
    1.  使用 `Crawl4AI` 或 `Playwright` 导航到视频播放页面。
    2.  通过执行 `js_code`，在页面上下文中运行一小段JavaScript代码，读取并提取出那个动态生成的参数值。
    3.  **组合拳:** 将提取到的动态参数，与我们已知的其他参数组合，然后使用 `requests` 库发送进度上报请求（依然是方案A的核心思路）。或者，如果页面自身的JS逻辑会定时上报，也可以仅保持页面打开来完成学习。

## 三、精简化的代码结构

*   `main.py`: 主流程控制器，负责调用登录、选课和学习模块。
*   `config.py`: 集中管理所有配置信息（账号、密码、URL、API端点等）。
*   `login.py`: 封装登录逻辑，负责获取并维护 `cookies.json`。
*   `course_analyzer.py`: 实现课程匹配与选择逻辑。输入课程列表，输出要学习的课程。
*   `course_learner.py`: **核心学习模块。** 根据**方案A**或**方案B**，实现具体的课程学习逻辑。
*   `api_client.py` (可选): 如果采用方案A，可将所有API请求封装在此模块中。
*   `utils.py`: 提供日志配置等通用辅助功能。